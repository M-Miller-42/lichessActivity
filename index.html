<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
    <title>Lichess Activity Heatmap</title>
    <link href="style.css" type="text/css" rel="stylesheet" />
</head>

<body>
    <h1>Daily Lichess Activity Heatmap</h1>
    <form id="inputForm">
        <div>
            <input id="usernameInput" type="text" placeholder="username" required>
            <input type="submit" id="submitBtn" value="Go">
        </div>

        <details>
            <summary>Filters</summary>
            <label for="datePicker">Start date (optional)
                <input id="datePicker" type="date">
            </label>
            <div id="filters"></div>
        </details>
    </form>
    <button id="loginBtn">Login to Lichess (optional)</button>
    <abbr title="The Lichess API is faster when logged in">Why?</abbr>

    <pre id="statusInfo"></pre>
    <div id="calendar"></div>
    <span>Be responsible with the amount of data you download. Consider becoming a <a
            href="https://lichess.org/patron">Lichess patron</a>.</span>
    <a href="https://github.com/M-Miller-42/lichessActivity" target="_blank" rel="noopener noreferrer">Source Code</a>




    <script src="OauthManager.js"></script>
    <script>
        'use strict'
        const FILTERS = ['ultraBullet', 'bullet', 'blitz', 'rapid', 'classical', 'correspondence', 'chess960', 'crazyhouse', 'antichess', 'atomic', 'horde', 'kingOfTheHill', 'racingKings', 'threeCheck']
        const LICHESS_API = 'https://lichess.org/api/'
        const LICHESS_OAUTH = 'https://lichess.org/oauth'
        const LICHESS_GAMES = 'https://lichess.org/@/'
        const CLIENT_ID = 'dailyActivityHeatmap'

        let headers = new Headers()
        const oauthLoginManager = new OauthLoginManager(LICHESS_OAUTH, LICHESS_API, CLIENT_ID)


        function activeFilters() {
            return Array.from(
                document.querySelectorAll('#filters :checked'),
                checkbox => checkbox.name)
                .join(',')
        }

        function getOrCreateYearNode(year, years) {
            if (years[year]) {
                return years[year]
            }
            const yearEl = document.createElement('div')
            yearEl.classList.add('year')
            yearEl.style.order = year
            yearEl.dataset.year = year

            'Mo,Tu,We,Th,Fr,Sa,Su'.split(',').forEach(weekday => {
                const weekdayEl = document.createElement('span')
                weekdayEl.textContent = weekday
                yearEl.appendChild(weekdayEl)
            })

            // If the year does not start with Monday, add some filler days
            // Starting with Monday=0
            const firstWeekdayIndex = (new Date(year, 0, 1).getDay() + 6) % 7
            for (const _ of Array(firstWeekdayIndex)) {
                yearEl.appendChild(document.createElement('div'))
            }

            calendar.appendChild(yearEl)
            years[year] = yearEl
            return yearEl
        }

        function getOrCreateDayNode(date, previous) {
            if (previous && previous.date.getTime() == date.getTime()) {
                return previous.dayEl
            }
            const dayEl = document.createElement('a')
            dayEl.classList.add('day')
            dayEl.href = createUrlForDay(date)
            dayEl.target = '_blank'
            return dayEl
        }

        function toLocalYYYYMMDD(date) {
            const local = new Date(date)
            local.setMinutes(date.getMinutes() - date.getTimezoneOffset())
            return local.toJSON().slice(0, 10)
        }

        function createUrlForDay(date) {
            const dayAfter = new Date(date)
            dayAfter.setDate(date.getDate() + 1)
            const url = new URL(LICHESS_GAMES)
            url.pathname += usernameInput.value
            url.pathname += '/search'
            url.searchParams.append('dateMin', toLocalYYYYMMDD(date))
            url.searchParams.append('dateMax', toLocalYYYYMMDD(dayAfter))
            url.searchParams.append('perf', activeFilters())
            return url
        }

        function createApiUrl(username, since) {
            const url = new URL(LICHESS_API)
            url.pathname += 'games/user/'
            url.pathname += username
            url.searchParams.append('sort', 'dateAsc')
            url.searchParams.append('moves', 'false')
            url.searchParams.append('evals', 'false')
            url.searchParams.append('perfType', activeFilters())
            since && url.searchParams.append('since', since)
            return url
        }

        async function onAuthorization(event) {
            headers.append('Authorization', 'Bearer ' + event.detail.token)
            const response = await fetch(LICHESS_API + 'account', { headers })
            const json = await response.json()
            loginBtn.onclick = () => oauthLoginManager.requestLogout()
            loginBtn.textContent = 'Logout with ' + json.username
        }

        async function onLogout() {
            headers = new Headers()
            statusInfo.innerText = 'Logged out'
            loginBtn.onclick = () => oauthLoginManager.requestLogin()
            loginBtn.textContent = 'Login to Lichess (optional)'
        }

        function resetGoBtn() {
            submitBtn.value = 'Go'
            submitBtn.onclick = undefined
        }

        async function createCalendar() {
            statusInfo.innerText = `Requesting games for user '${usernameInput.value}'`

            const aborter = new AbortController()
            const since = datePicker.valueAsDate?.getTime()
            const years = {}
            const days = {}
            let maxPerDay = 0
            let gameCounter = 0
            let previousDay
            let lastInThisChunk
            let lastInPreviousChunk

            submitBtn.value = 'Abort'
            submitBtn.onclick = e => { e.preventDefault(); aborter.abort(); statusInfo.innerText += ' Aborted!'; resetGoBtn() }

            calendar.replaceChildren()

            const url = createApiUrl(usernameInput.value, since)
            const response = await fetch(url, { signal: aborter.signal, headers })
            if (!response.ok) {
                statusInfo.innerText = `Error ${response.status} while fetching games for user '${usernameInput.value}'`
                resetGoBtn()
                return
            }

            // for await is not supported in Chrome
            // for await (const chunk of response.body)
            const reader = response.body.getReader();
            let chunk, done = false
            while (!done) {
                ({ value: chunk, done } = await reader.read())
                if (done) break
                const games = new TextDecoder().decode(chunk).split('\n\n\n').filter(game => game)

                for (const game of games) {
                    statusInfo.innerText = `Downloaded ${gameCounter += 1} games`
                    const { year, month, day } = game.match(/\[Date "(?<year>\d\d\d\d)\.(?<month>\d\d)\.(?<day>\d\d)"\]/).groups
                    const date = new Date(year, month - 1, day)
                    const entry = days[date.getTime()] ?? 0
                    days[date.getTime()] = entry + 1
                    maxPerDay = Math.max(maxPerDay, entry + 1)
                    lastInThisChunk = date
                }

                calendar.style.setProperty('--max', maxPerDay)

                // Fallback to first day of year
                lastInPreviousChunk = lastInPreviousChunk ?? new Date(lastInThisChunk.getFullYear(), 0, 1)
                for (let date = lastInPreviousChunk; date <= lastInThisChunk; date.setDate(date.getDate() + 1)) {
                    const gamesPlayed = days[date.getTime()] ?? 0
                    const dayEl = getOrCreateDayNode(date, previousDay)
                    previousDay = { date: new Date(date), dayEl }
                    dayEl.title = gamesPlayed + ' games played on ' + date.toDateString()
                    dayEl.style.setProperty('--x', gamesPlayed)
                    dayEl.style.setProperty('--r', 'calc(var(--x) / var(--max)')
                    const yearEl = getOrCreateYearNode(date.getFullYear(), years)
                    yearEl.appendChild(dayEl)
                }
                lastInPreviousChunk = lastInThisChunk
            }
            statusInfo.innerText += ' Done!'
            resetGoBtn()
        }

        async function initialize() {
            inputForm.onsubmit = e => { e.preventDefault(); createCalendar() }
            loginBtn.onclick = () => oauthLoginManager.requestLogin()

            FILTERS.forEach(filter => {
                const label = document.createElement('label')
                label.textContent = filter
                const checkbox = document.createElement('input')
                checkbox.type = 'checkbox'
                checkbox.name = filter
                checkbox.checked = true
                label.prepend(checkbox)
                filters.appendChild(label)
            })
            oauthLoginManager.addEventListener('authorization', onAuthorization)
            oauthLoginManager.addEventListener('logout', onLogout)

            try {
                await oauthLoginManager.initialize()
            } catch (error) {
                await oauthLoginManager.requestLogout()
                statusInfo.textContent = error.message
            }
        }

        initialize()

    </script>
</body>

</html>